<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baymax | Your Emotional Wellness Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            /* A pleasant, calming gradient background */
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 50%, #e0e7ff 100%);
        }
        .chat-bubble {
            max-width: 75%;
            word-wrap: break-word;
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        /* Breathing circle animation helpers */
        .breath-circle {
            transition: transform 1s ease-in-out, background-color 0.3s ease;
        }
        .breath-in {
            transform: scale(1.15);
            background-color: #a5b4fc; /* indigo-300 */
        }
        .breath-hold {
            transform: scale(1.15);
            background-color: #93c5fd; /* blue-300 */
        }
        .breath-out {
            transform: scale(0.9);
            background-color: #bfdbfe; /* blue-200 */
        }
        /* Pulse animation for listening state */
        .listening {
            animation: pulse 1.5s infinite;
            color: #ef4444; /* red-500 */
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        /* Glassmorphism effect for panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Breathing Animation Styling */
        .breathing-pulse-circle {
            transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .breathing-active {
            transform: scale(1.05);
            box-shadow: 0 0 40px 10px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Application Container -->
    <div class="flex h-screen w-screen">
        
        <!-- Left Panel: Chat Interface -->
        <div class="w-full md:w-2/3 lg:w-3/5 flex flex-col bg-white/30 border-r border-white/30">
            <header class="p-4 border-b border-white/30 flex justify-between items-center glass-panel">
                <h1 class="text-xl font-bold text-gray-700">Baymax</h1>
                <div class="text-xs text-gray-500">Your Safe Space</div>
                <div class="flex items-center space-x-2">
                    <button id="open-settings-button" class="text-gray-500 hover:text-indigo-600" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.6 15a1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 3.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 3.6a1.65 1.65 0 0 0 1-1.51V2a2 2 0 1 1 4 0v.09c0 .66.39 1.26 1 1.51.61.25 1.31.11 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.44.51-.58 1.21-.33 1.82.25.61.85 1 1.51 1H22a2 2 0 1 1 0 4h-.09c-.66 0-1.26.39-1.51 1z"></path></svg>
                    </button>
                </div>
            </header>
            
            <!-- Chat Messages -->
            <main id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container">
                <div class="flex justify-start mb-4">
                    <div class="chat-bubble bg-indigo-500 text-white rounded-lg p-3 shadow-md">
                        <p>Hello! I'm Baymax, your emotional wellness companion. How are you feeling today?</p>
                    </div>
                </div>
            </main>

            <!-- Input Area -->
            <footer class="p-4 border-t border-white/30 glass-panel">
                <form id="chat-form" class="flex items-center space-x-3">
                    <textarea id="message-input" rows="1" class="flex-1 p-3 border border-gray-300/50 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none bg-white/80" placeholder="Type your message or use the mic..."></textarea>
                    <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-200 shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                    <button type="button" id="mic-button" class="p-3 text-gray-500 hover:text-indigo-600 transition-colors duration-200" title="Use Microphone">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <button type="button" id="toggle-tts-button" class="p-3 text-gray-500 hover:text-indigo-600" title="Toggle Voice Response">
                        <svg id="tts-on-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        <svg id="tts-off-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="1" x2="1" y2="23"></line><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    </button>
                    <button type="button" id="clear-chat-button" class="p-3 text-gray-500 hover:text-red-600 transition-colors duration-200" title="Clear chat history">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <button type="button" id="breath-button" class="p-3 text-gray-500 hover:text-indigo-600 transition-colors duration-200" title="Open Breathing Timer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 16.5V21h4.5L20.29 8.21a1 1 0 0 0 0-1.41L17.2 3.71a1 1 0 0 0-1.41 0L3 16.5z"></path></svg>
                    </button>
                     <button type="button" id="camera-button" class="p-3 text-gray-500 hover:text-indigo-600" title="Use Camera (with permission)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    </button>
                </form>
                <div class="mt-3">
                    <div class="text-xs text-gray-500 mb-1">Quick mood check-in:</div>
                    <div id="mood-picker" class="flex flex-wrap gap-2">
                        <button data-mood="calm" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜Š Calm</button>
                        <button data-mood="anxious" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜Ÿ Anxious</button>
                        <button data-mood="stressed" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜« Stressed</button>
                        <button data-mood="focused" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ¤“ Focused</button>
                        <button data-mood="tired" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜´ Tired</button>
                        <button data-mood="sad" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜¢ Sad</button>
                        <button data-mood="hopeful" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜Œ Hopeful</button>
                        <button data-mood="proud" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ¥³ Proud</button>
                        <button data-mood="frustrated" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜¤ Frustrated</button>
                        <button data-mood="bored" class="px-2 py-1 rounded-md bg-white/60 hover:bg-white text-sm transition">ðŸ˜‘ Bored</button>
                    </div>
                </div>
            </footer>
        </div>

        <!-- Right Panel: Dashboard -->
        <div class="hidden md:flex w-1/3 lg:w-2/5 flex-col p-6 space-y-6 overflow-y-auto">
            <!-- Mood Indicator -->
            <div class="glass-panel p-6 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Current Emotional State</h2>
                <div class="flex items-center space-x-4">
                    <div id="mood-emoji" class="text-6xl">ðŸ˜Š</div>
                    <div>
                        <p id="mood-text" class="text-xl font-medium text-gray-800">Calm</p>
                        <p id="mood-indicator-subtitle" class="text-sm text-gray-500">Based on recent conversation.</p>
                    </div>
                </div>
            </div>

            <!-- Live Video Feed (Initially hidden) -->
            <div id="video-feed-container" class="glass-panel p-6 rounded-xl shadow-md hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">Live Video Feed</h2>
                    <button id="stop-camera-button" class="text-sm font-semibold text-red-600 hover:text-red-800 transition">Stop Camera</button>
                </div>
                <video id="video-feed" class="w-full rounded-lg bg-gray-900" autoplay playsinline></video>
                <p class="text-xs text-gray-500 mt-2 text-center">Your video is processed on your device and is never sent to our servers.</p>
            </div>

            <!-- Weekly Mood Report -->
            <div class="glass-panel p-6 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Weekly Mood Report</h2>
                <div class="flex justify-around items-end h-32 space-x-2">
                    <div class="flex flex-col items-center"><div class="w-8 bg-sky-300 rounded-t-lg" style="height: 60%;"></div><span class="text-xs mt-1">Mon</span></div>
                    <div class="flex flex-col items-center"><div class="w-8 bg-teal-300 rounded-t-lg" style="height: 80%;"></div><span class="text-xs mt-1">Tue</span></div>
                    <div class="flex flex-col items-center"><div class="w-8 bg-indigo-300 rounded-t-lg" style="height: 90%;"></div><span class="text-xs mt-1">Wed</span></div>
                    <div class="flex flex-col items-center"><div class="w-8 bg-sky-300 rounded-t-lg" style="height: 50%;"></div><span class="text-xs mt-1">Thu</span></div>
                    <div class="flex flex-col items-center"><div class="w-8 bg-teal-300 rounded-t-lg" style="height: 70%;"></div><span class="text-xs mt-1">Fri</span></div>
                    <div class="flex flex-col items-center"><div class="w-8 bg-cyan-300 rounded-t-lg" style="height: 40%;"></div><span class="text-xs mt-1">Sat</span></div>
                    <div class="flex flex-col items-center"><div class="w-8 bg-cyan-300 rounded-t-lg" style="height: 60%;"></div><span class="text-xs mt-1">Sun</span></div>
                </div>
                <p class="text-sm text-gray-500 mt-2 text-center">Stress levels were highest mid-week.</p>
            </div>

            <!-- Guided Meditations -->
            <div class="glass-panel p-6 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Guided Meditations</h2>
                <div id="meditation-container" class="space-y-3">
                    <!-- Meditations will be dynamically inserted here -->
                </div>
            </div>

            <!-- Breathing Exercise -->
            <div class="glass-panel p-6 rounded-xl shadow-md">
                 <h2 class="text-lg font-semibold text-gray-700 mb-2">Breathing Exercise</h2>
                 <p id="breathing-animation-instruction" class="text-sm text-gray-600 mb-4">Press start to begin a guided session.</p>
                 <div class="flex items-center justify-center space-x-6">
                     <div class="relative w-40 h-40">
                         <div id="breathing-pulse-circle" class="absolute inset-0 rounded-full bg-indigo-200 breathing-pulse-circle"></div>
                         <div id="breathing-animation-circle" class="absolute inset-2 rounded-full bg-indigo-400 breath-circle flex items-center justify-center transition-all duration-1000">
                             <span id="breathing-animation-phase" class="text-xl font-semibold text-white">Ready</span>
                         </div>
                     </div>
                     <div class="flex flex-col space-y-2">
                         <button id="breathing-animation-start" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">Start</button>
                         <button id="breathing-animation-stop" class="px-4 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 transition">Stop</button>
                     </div>
                 </div>
            </div>

        </div>
    </div>

    <!-- Permissions Modal -->
    <div id="permissions-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md text-center glass-panel">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-indigo-500"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Enable Your Camera and Mic</h2>
            <p class="text-gray-600 mb-6">To provide real-time emotional feedback, Baymax needs your permission to access your camera for facial expression analysis and your microphone for voice tone analysis. Your data is processed securely.</p>
            <div class="flex justify-center space-x-4">
                <button id="deny-permissions-button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-8 rounded-lg hover:bg-gray-300 transition duration-200">Not Now</button>
                <button id="allow-permissions-button" class="bg-indigo-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-indigo-700 transition duration-200">Allow</button>
            </div>
        </div>
    </div>

    <!-- Crisis Intervention Modal -->
    <div id="crisis-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg text-center glass-panel">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-red-500"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">It sounds like you need immediate support.</h2>
            <p class="text-gray-600 mb-6">If you are in a crisis or any other person may be in danger, please don't use this site. These resources can provide you with immediate help.</p>
            <div class="space-y-4">
                <a href="tel:988" class="block w-full bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-200">Call a Crisis Hotline (988)</a>
                <a href="#" class="block w-full bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition duration-200">Find Local University Resources</a>
            </div>
            <button id="close-modal-button" class="mt-6 text-sm text-gray-500 hover:text-gray-700">Close this message</button>
        </div>
    </div>

    <!-- TTS Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg glass-panel">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Voice Settings</h3>
                <button id="close-settings-button" class="text-gray-500 hover:text-gray-700">Close</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Voice</label>
                    <select id="tts-voice" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Rate: <span id="tts-rate-label" class="font-medium">1.0</span></label>
                    <input id="tts-rate" type="range" min="0.5" max="1.5" step="0.05" value="1.0" class="w-full">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Pitch: <span id="tts-pitch-label" class="font-medium">1.0</span></label>
                    <input id="tts-pitch" type="range" min="0.5" max="2.0" step="0.05" value="1.0" class="w-full">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Volume: <span id="tts-volume-label" class="font-medium">1.0</span></label>
                    <input id="tts-volume" type="range" min="0" max="1" step="0.05" value="1.0" class="w-full">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="settings-reset" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Reset</button>
                <button id="settings-save" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Breathing Timer Modal (Legacy, can be removed or kept as alternative) -->
    <div id="breath-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md text-center glass-panel">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Breathing Timer</h3>
            <p id="breath-phase" class="text-sm text-gray-500 mb-4">Ready</p>
            <div class="mx-auto w-40 h-40 rounded-full bg-indigo-200 breath-circle flex items-center justify-center">
                <span id="breath-count" class="text-2xl font-semibold text-indigo-800">4</span>
            </div>
            <div class="flex items-center justify-center space-x-3 mt-6">
                <button id="breath-start" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Start</button>
                <button id="breath-pause" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Pause</button>
                <button id="breath-stop" class="px-4 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">Stop</button>
                <button id="breath-close" class="px-4 py-2 rounded-lg">Close</button>
            </div>
            <div class="mt-3 text-xs text-gray-500">Pattern: Inhale 4s â€¢ Hold 4s â€¢ Exhale 6s</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const chatContainer = document.getElementById('chat-container');
            const moodEmoji = document.getElementById('mood-emoji');
            const moodText = document.getElementById('mood-text');
            const moodIndicatorSubtitle = document.getElementById('mood-indicator-subtitle');
            const crisisModal = document.getElementById('crisis-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const micButton = document.getElementById('mic-button');
            const cameraButton = document.getElementById('camera-button');
            const meditationContainer = document.getElementById('meditation-container');
            const videoFeedContainer = document.getElementById('video-feed-container');
            const videoFeed = document.getElementById('video-feed');
            const stopCameraButton = document.getElementById('stop-camera-button');
            const permissionsModal = document.getElementById('permissions-modal');
            const allowPermissionsButton = document.getElementById('allow-permissions-button');
            const denyPermissionsButton = document.getElementById('deny-permissions-button');
            const clearChatButton = document.getElementById('clear-chat-button');
            const openSettingsButton = document.getElementById('open-settings-button');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsButton = document.getElementById('close-settings-button');
            const ttsVoiceSelect = document.getElementById('tts-voice');
            const ttsRate = document.getElementById('tts-rate');
            const ttsRateLabel = document.getElementById('tts-rate-label');
            const ttsPitch = document.getElementById('tts-pitch');
            const ttsPitchLabel = document.getElementById('tts-pitch-label');
            const ttsVolume = document.getElementById('tts-volume');
            const ttsVolumeLabel = document.getElementById('tts-volume-label');
            const settingsSave = document.getElementById('settings-save');
            const settingsReset = document.getElementById('settings-reset');
            const moodPicker = document.getElementById('mood-picker');
            const toggleTtsButton = document.getElementById('toggle-tts-button');
            const ttsOnIcon = document.getElementById('tts-on-icon');
            const ttsOffIcon = document.getElementById('tts-off-icon');
            
            // Legacy Breathing Modal
            const breathButton = document.getElementById('breath-button');
            const breathModal = document.getElementById('breath-modal');
            const breathPhase = document.getElementById('breath-phase');
            const breathCount = document.getElementById('breath-count');
            const breathStart = document.getElementById('breath-start');
            const breathPause = document.getElementById('breath-pause');
            const breathStop = document.getElementById('breath-stop');
            const breathClose = document.getElementById('breath-close');
            const breathCircle = document.querySelector('.breath-circle');

            // New Breathing Animation Elements
            const breathingAnimationStart = document.getElementById('breathing-animation-start');
            const breathingAnimationStop = document.getElementById('breathing-animation-stop');
            const breathingAnimationCircle = document.getElementById('breathing-animation-circle');
            const breathingPulseCircle = document.getElementById('breathing-pulse-circle');
            const breathingAnimationPhase = document.getElementById('breathing-animation-phase');
            const breathingAnimationInstruction = document.getElementById('breathing-animation-instruction');

            // --- Configuration & Data ---
            const crisisKeywords = ['suicide', 'kill myself', 'self-harm', 'in danger', 'can\'t go on', 'hopeless', 'help me i\'m in crisis'];
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
            }

            const meditations = [
                {
                    id: 'breathing',
                    title: '5-Minute Breathing',
                    description: 'Quickly calm your nerves.',
                    theme: 'indigo',
                    script: "Welcome. Let's begin by finding a comfortable position. Close your eyes gently. Bring your attention to your breath. Inhale slowly through your nose, feeling your belly expand. One... two... three... four. Now, exhale slowly through your mouth. One... two... three... four... five... six. Continue this pattern. Inhale peace... exhale tension. Let your thoughts come and go like clouds in the sky. You are calm, you are present. Take one more deep breath in... and release. When you're ready, slowly open your eyes."
                },
                {
                    id: 'focus',
                    title: 'Mindfulness for Focus',
                    description: 'For pre-study sessions.',
                    theme: 'green',
                    script: "Hello. Let's prepare your mind for focus. Sit upright but relaxed. Close your eyes. Imagine a single point of light in front of you. This light is your focus. As you breathe in, imagine the light growing brighter. As you breathe out, release any distracting thoughts. If your mind wanders, gently guide it back to the light. This is your anchor. Stay with this light for a few more moments. Feel your mind becoming clear and sharp. You are ready to concentrate. Open your eyes, focused and prepared."
                }
            ];

            // --- State ---
            let mediaStream = null;
            let emotionAnalysisInterval = null;
            let requestedPermissionType = null;
            let isListening = false;
            let activeMeditationId = null;
            let activeUtterance = null;
            let ttsSettings = loadTtsSettings();
            let isTtsEnabled = loadTtsEnabledState();
            
            // Legacy breathing timer state
            let legacyBreathTimer = null;
            let legacyBreathPhaseIdx = 0;
            let legacyBreathRemaining = 4;
            const legacyBreathDurations = [4, 4, 6];
            const legacyBreathLabels = ['Inhale', 'Hold', 'Exhale'];
            
            // New breathing animation state
            let breathTimer = null;
            let breathPhaseIdx = 0;
            let breathRemaining = 4;
            const breathDurations = [4, 4, 6];
            const breathLabels = ['Inhale', 'Hold', 'Exhale'];
            const breathNotes = ['C4', 'E4', 'G4'];
            let isAudioReady = false;
            let guideSynth, musicFilter, noise;


            const moodStates = {
                calm: { emoji: 'ðŸ˜Š', text: 'Calm' },
                anxious: { emoji: 'ðŸ˜Ÿ', text: 'Anxious' },
                stressed: { emoji: 'ðŸ˜«', text: 'Stressed' },
                focused: { emoji: 'ðŸ¤“', text: 'Focused' },
                tired: { emoji: 'ðŸ˜´', text: 'Tired' },
                sad: { emoji: 'ðŸ˜¢', text: 'Sad' },
                hopeful: { emoji: 'ðŸ˜Œ', text: 'Hopeful' },
                proud: { emoji: 'ðŸ¥³', text: 'Proud' },
                frustrated: { emoji: 'ðŸ˜¤', text: 'Frustrated' },
                bored: { emoji: 'ðŸ˜‘', text: 'Bored' },
            };

            // --- Initial Setup ---
            populateMeditations();
            restoreChatHistory();
            setupTtsSettingsUI();
            initBreathingAnimation();
            updateTtsButtonUI();

            // --- Event Listeners ---
            chatForm.addEventListener('submit', handleSendMessage);
            messageInput.addEventListener('input', autoResizeTextarea);
            closeModalButton.addEventListener('click', () => crisisModal.classList.add('hidden'));
            micButton.addEventListener('click', toggleListening);
            cameraButton.addEventListener('click', () => requestPermission('camera'));
            stopCameraButton.addEventListener('click', stopVideoStream);
            allowPermissionsButton.addEventListener('click', handlePermissionGrant);
            denyPermissionsButton.addEventListener('click', () => permissionsModal.classList.add('hidden'));
            clearChatButton.addEventListener('click', clearChatHistory);
            openSettingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettingsButton.addEventListener('click', () => settingsModal.classList.add('hidden'));
            settingsSave.addEventListener('click', () => { saveTtsSettingsFromUI(); settingsModal.classList.add('hidden'); });
            settingsReset.addEventListener('click', () => { resetTtsSettings(); setupTtsSettingsUI(); });
            moodPicker.addEventListener('click', onMoodPick);
            toggleTtsButton.addEventListener('click', toggleTts);
            
            // Legacy breathing listeners
            breathButton.addEventListener('click', () => { breathModal.classList.remove('hidden'); initLegacyBreathing(); });
            breathClose.addEventListener('click', () => { stopLegacyBreathing(); breathModal.classList.add('hidden'); });
            breathStart.addEventListener('click', startLegacyBreathing);
            breathPause.addEventListener('click', pauseLegacyBreathing);
            breathStop.addEventListener('click', stopLegacyBreathing);

            // New breathing animation listeners
            breathingAnimationStart.addEventListener('click', startBreathingAnimation);
            breathingAnimationStop.addEventListener('click', stopBreathingAnimation);

            if (recognition) {
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                    autoResizeTextarea();
                    chatForm.requestSubmit(); // Auto-submit
                };
                recognition.onerror = (event) => console.error("Speech recognition error:", event.error);
                recognition.onend = () => {
                    isListening = false;
                    micButton.classList.remove('listening');
                };
            }

            // --- Functions ---

            function populateMeditations() {
                meditationContainer.innerHTML = '';
                meditations.forEach(med => {
                    const item = document.createElement('div');
                    item.className = `flex items-center justify-between p-3 bg-${med.theme}-50/50 rounded-lg hover:bg-${med.theme}-100/50 transition duration-200 cursor-pointer meditation-item`;
                    item.dataset.id = med.id;
                    item.innerHTML = `
                        <div>
                            <p class="font-medium text-${med.theme}-800">${med.title}</p>
                            <p class="text-sm text-${med.theme}-600">${med.description}</p>
                        </div>
                        <div class="icon-container relative w-10 h-10 flex items-center justify-center">
                            <div class="play-icon p-2 bg-white rounded-full shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-${med.theme}-600"><path d="M8 5v14l11-7z"></path></svg>
                            </div>
                             <div class="pause-icon hidden p-2 bg-white rounded-full shadow-sm">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-${med.theme}-600"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                            </div>
                        </div>
                    `;
                    item.addEventListener('click', () => handleMeditationClick(med.id));
                    meditationContainer.appendChild(item);
                });
            }

            function onMoodPick(e) {
                if (e.target.tagName !== 'BUTTON') return;
                const moodKey = e.target.getAttribute('data-mood');
                if (!moodKey) return;
                updateMoodDashboard(moodKey);
                appendMessage('ai', `Noted. I see you're feeling ${moodKey}. I'm here with you.`);
            }

            function handleMeditationClick(meditationId) {
                const meditation = meditations.find(m => m.id === meditationId);
                if (!meditation) return;

                const interruptedByNewSelection = activeMeditationId && activeMeditationId !== meditationId;

                if (activeMeditationId === meditationId && speechSynthesis.speaking && !speechSynthesis.paused) {
                    speechSynthesis.pause();
                    updateMeditationUI(meditationId, 'paused');
                    return;
                }

                if (activeMeditationId === meditationId && speechSynthesis.paused) {
                    speechSynthesis.resume();
                    updateMeditationUI(meditationId, 'playing');
                    return;
                }

                speechSynthesis.cancel(); 
                
                setTimeout(() => {
                    activeUtterance = new SpeechSynthesisUtterance(meditation.script);
                    applyTtsSettings(activeUtterance);
                    activeMeditationId = meditationId;

                    activeUtterance.onend = () => {
                        updateMeditationUI(meditationId, 'ended');
                        activeMeditationId = null;
                        activeUtterance = null;
                    };
                    
                    activeUtterance.onerror = (err) => {
                        if (err.error !== 'interrupted') {
                            console.error("Speech synthesis error:", err.error, err);
                        }
                        updateMeditationUI(meditationId, 'ended');
                        activeMeditationId = null;
                        activeUtterance = null;
                    };

                    speechSynthesis.speak(activeUtterance);
                    updateMeditationUI(meditationId, 'playing');
                }, interruptedByNewSelection ? 100 : 0);
            }

            function updateMeditationUI(meditationId, state) {
                document.querySelectorAll('.meditation-item').forEach(item => {
                    if (item.dataset.id !== meditationId) {
                       item.querySelector('.play-icon').classList.remove('hidden');
                       item.querySelector('.pause-icon').classList.add('hidden');
                    }
                });

                const currentItem = document.querySelector(`.meditation-item[data-id="${meditationId}"]`);
                if (!currentItem) return;

                const playIcon = currentItem.querySelector('.play-icon');
                const pauseIcon = currentItem.querySelector('.pause-icon');

                if (state === 'playing') {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else { 
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            }

            function handleSendMessage(e) {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message) return;

                appendMessage('user', message);
                messageInput.value = '';
                autoResizeTextarea();

                if (checkForCrisis(message)) {
                    showCrisisModal();
                } else {
                    simulateAIResponse(message);
                }
                saveChatHistory();
            }
            
            function appendMessage(sender, text) {
                const isUser = sender === 'user';
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`;
                const messageBubble = document.createElement('div');
                messageBubble.className = `chat-bubble rounded-lg p-3 shadow-md`;
                messageBubble.classList.add(isUser ? 'bg-gray-700' : 'bg-indigo-500', 'text-white');
                messageBubble.textContent = text;
                messageWrapper.appendChild(messageBubble);
                chatContainer.appendChild(messageWrapper);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                if (!isUser && isTtsEnabled) {
                    speechSynthesis.cancel(); // Stop any previous speech
                    const utterance = new SpeechSynthesisUtterance(text);
                    applyTtsSettings(utterance);
                    speechSynthesis.speak(utterance);
                }
            }

            function autoResizeTextarea() {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            }

            function saveChatHistory() {
                const nodes = Array.from(chatContainer.children);
                const history = nodes.map(node => {
                    const isUser = node.classList.contains('justify-end');
                    const text = node.querySelector('.chat-bubble')?.textContent || '';
                    return { s: isUser ? 'u' : 'a', t: text };
                }).filter(item => item.t);
                try {
                    localStorage.setItem('baymax_chat_history', JSON.stringify(history));
                } catch (_) {}
            }

            function restoreChatHistory() {
                try {
                    const raw = localStorage.getItem('baymax_chat_history');
                    if (!raw) return;
                    const history = JSON.parse(raw);
                    if (!Array.isArray(history) || history.length === 0) return;
                    chatContainer.innerHTML = '';
                    history.forEach(item => appendMessage(item.s === 'u' ? 'user' : 'ai', item.t));
                } catch (_) {}
            }

            function clearChatHistory() {
                if (!confirm('Are you sure you want to clear the chat history? This cannot be undone.')) return;
                localStorage.removeItem('baymax_chat_history');
                chatContainer.innerHTML = '';
                 appendMessage('ai', "Let's start fresh. How are you feeling right now?");
            }

            function toggleListening() {
                if (!SpeechRecognition) {
                    alert("Sorry, your browser doesn't support speech recognition.");
                    return;
                }
                if (isListening) {
                    recognition.stop();
                } else {
                    speechSynthesis.cancel(); // Stop Baymax from talking if we interrupt to speak
                    requestPermission('mic');
                }
            }

            function requestPermission(type) {
                requestedPermissionType = type;
                permissionsModal.classList.remove('hidden');
            }

            async function handlePermissionGrant() {
                permissionsModal.classList.add('hidden');
                if (requestedPermissionType === 'camera') {
                    await startVideoStream();
                } else if (requestedPermissionType === 'mic') {
                    await startAudioStream();
                }
            }

            async function startAudioStream() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); 
                    isListening = true;
                    micButton.classList.add('listening');
                    recognition.start();
                } catch (error) {
                    console.error("Error accessing microphone:", error);
                    alert("Could not access the microphone. Please grant permission in your browser settings.");
                }
            }

            async function startVideoStream() {
                if (mediaStream) stopVideoStream();
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    videoFeed.srcObject = mediaStream;
                    videoFeedContainer.classList.remove('hidden');
                    moodIndicatorSubtitle.textContent = 'Analyzing live video feed...';
                    emotionAnalysisInterval = setInterval(() => {
                        const moods = Object.keys(moodStates);
                        const randomMood = moods[Math.floor(Math.random() * moods.length)];
                        updateMoodDashboard(randomMood);
                    }, 2000);
                } catch (error) {
                    console.error("Error accessing camera:", error);
                    alert("Could not access the camera. Please grant permission in your browser settings.");
                }
            }

            function stopVideoStream() {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    videoFeed.srcObject = null;
                    mediaStream = null;
                    videoFeedContainer.classList.add('hidden');
                    clearInterval(emotionAnalysisInterval);
                    emotionAnalysisInterval = null;
                    moodIndicatorSubtitle.textContent = 'Based on recent conversation.';
                    updateMoodDashboard('calm');
                }
            }

            function checkForCrisis(message) {
                const lowerCaseMessage = message.toLowerCase();
                return crisisKeywords.some(keyword => lowerCaseMessage.includes(keyword));
            }

            function showCrisisModal() {
                crisisModal.classList.remove('hidden');
            }

            function simulateAIResponse(userInput) {
                setTimeout(() => {
                    const aiResponse = getEmpatheticResponse(userInput);
                    appendMessage('ai', aiResponse.text);
                    updateMoodDashboard(aiResponse.mood);
                    saveChatHistory();
                }, 1000 + Math.random() * 500);
            }

            function getEmpatheticResponse(input) {
                const lowerInput = input.toLowerCase();
                if (lowerInput.includes('exam') || lowerInput.includes('stressed') || lowerInput.includes('anxious') || lowerInput.includes('overwhelmed')) {
                    return { text: "It sounds like you're under a lot of pressure right now. That's completely understandable. The breathing exercise on your dashboard is great for finding a moment of calm. Would you like to try it, or perhaps talk more about what's on your mind?", mood: 'stressed' };
                }
                if (lowerInput.includes('sad') || lowerInput.includes('upset')) {
                    return { text: "I'm really sorry to hear you're feeling sad. Please remember it's okay to feel this way. I'm here to listen without judgment whenever you're ready to talk.", mood: 'sad' };
                }
                if (lowerInput.includes('tired') || lowerInput.includes('exhausted')) {
                    return { text: "It sounds like you're completely exhausted. Please make sure you're getting enough rest. Proper sleep is so important for both your mind and body.", mood: 'tired' };
                }
                if (lowerInput.includes('happy') || lowerInput.includes('great') || lowerInput.includes('proud')) {
                    return { text: "That's wonderful to hear! I'm so glad you're feeling positive today. Let's celebrate that feeling!", mood: 'proud' };
                }
                if (lowerInput.includes('frustrated') || lowerInput.includes('annoyed')) {
                    return { text: "It's completely normal to feel frustrated sometimes. Is there anything specific that's causing this feeling? Sometimes just talking it through can help lighten the load.", mood: 'frustrated' };
                }
                return { text: "Thank you for sharing that with me. I'm listening. Could you tell me a little more about what's happening?", mood: 'calm' };
            }

            function updateMoodDashboard(moodKey) {
                const state = moodStates[moodKey] || moodStates.calm;
                moodEmoji.textContent = state.emoji;
                moodText.textContent = state.text;
            }

            function loadTtsSettings() {
                try {
                    const raw = localStorage.getItem('baymax_tts_settings');
                    if (!raw) return { voiceName: '', rate: 1.0, pitch: 1.0, volume: 1.0 };
                    return JSON.parse(raw);
                } catch (_) {
                    return { voiceName: '', rate: 1.0, pitch: 1.0, volume: 1.0 };
                }
            }

            function setupTtsSettingsUI() {
                function fillVoices() {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length === 0) return;
                    ttsVoiceSelect.innerHTML = '';
                    voices.filter(v => v.lang.startsWith('en')).forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v.name;
                        opt.textContent = `${v.name} (${v.lang})` + (v.default ? ' â€” default' : '');
                        ttsVoiceSelect.appendChild(opt);
                    });
                    if (ttsSettings.voiceName) ttsVoiceSelect.value = ttsSettings.voiceName;
                }
                fillVoices();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = fillVoices;
                }
                ttsRate.value = ttsSettings.rate;
                ttsPitch.value = ttsSettings.pitch;
                ttsVolume.value = ttsSettings.volume;
                ttsRateLabel.textContent = String(ttsSettings.rate);
                ttsPitchLabel.textContent = String(ttsSettings.pitch);
                ttsVolumeLabel.textContent = String(ttsSettings.volume);
                ttsRate.addEventListener('input', () => ttsRateLabel.textContent = ttsRate.value);
                ttsPitch.addEventListener('input', () => ttsPitchLabel.textContent = ttsPitch.value);
                ttsVolume.addEventListener('input', () => ttsVolumeLabel.textContent = ttsVolume.value);
            }

            function saveTtsSettingsFromUI() {
                ttsSettings = {
                    voiceName: ttsVoiceSelect.value || '',
                    rate: Number(ttsRate.value) || 1.0,
                    pitch: Number(ttsPitch.value) || 1.0,
                    volume: Number(ttsVolume.value) || 1.0,
                };
                try { localStorage.setItem('baymax_tts_settings', JSON.stringify(ttsSettings)); } catch (_) {}
            }

            function resetTtsSettings() {
                ttsSettings = { voiceName: '', rate: 1.0, pitch: 1.0, volume: 1.0 };
                try { localStorage.removeItem('baymax_tts_settings'); } catch (_) {}
            }

            function applyTtsSettings(utterance) {
                if (!utterance) return;
                utterance.rate = ttsSettings.rate;
                utterance.pitch = ttsSettings.pitch;
                utterance.volume = ttsSettings.volume;
                if (ttsSettings.voiceName) {
                    const voice = speechSynthesis.getVoices().find(v => v.name === ttsSettings.voiceName);
                    if (voice) utterance.voice = voice;
                }
            }

            // --- TTS Toggle ---
            function toggleTts() {
                isTtsEnabled = !isTtsEnabled;
                saveTtsEnabledState();
                updateTtsButtonUI();
                if (!isTtsEnabled) {
                    speechSynthesis.cancel(); // Stop any speech if user mutes
                }
            }

            function updateTtsButtonUI() {
                if (isTtsEnabled) {
                    ttsOnIcon.classList.remove('hidden');
                    ttsOffIcon.classList.add('hidden');
                } else {
                    ttsOnIcon.classList.add('hidden');
                    ttsOffIcon.classList.remove('hidden');
                }
            }

            function saveTtsEnabledState() {
                try { localStorage.setItem('baymax_tts_enabled', isTtsEnabled); } catch(_) {}
            }

            function loadTtsEnabledState() {
                try {
                    const state = localStorage.getItem('baymax_tts_enabled');
                    return state === 'false' ? false : true; // Default to true
                } catch(_) {
                    return true;
                }
            }


            // --- Legacy Breathing Timer logic ---
            function initLegacyBreathing() {
                legacyBreathPhaseIdx = 0;
                legacyBreathRemaining = legacyBreathDurations[0];
                updateLegacyBreathUI();
            }

            function startLegacyBreathing() {
                clearInterval(legacyBreathTimer);
                legacyBreathTimer = setInterval(() => {
                    legacyBreathRemaining -= 1;
                    if (legacyBreathRemaining <= 0) {
                        legacyBreathPhaseIdx = (legacyBreathPhaseIdx + 1) % 3;
                        legacyBreathRemaining = legacyBreathDurations[legacyBreathPhaseIdx];
                    }
                    updateLegacyBreathUI();
                }, 1000);
                updateLegacyBreathUI();
            }

            function pauseLegacyBreathing() {
                clearInterval(legacyBreathTimer);
            }

            function stopLegacyBreathing() {
                clearInterval(legacyBreathTimer);
                legacyBreathTimer = null;
                initLegacyBreathing();
            }

            function updateLegacyBreathUI() {
                breathPhase.textContent = `${legacyBreathLabels[legacyBreathPhaseIdx]}`;
                breathCount.textContent = String(legacyBreathRemaining);
                breathCircle.classList.remove('breath-in', 'breath-hold', 'breath-out');
                if (legacyBreathPhaseIdx === 0) breathCircle.classList.add('breath-in');
                if (legacyBreathPhaseIdx === 1) breathCircle.classList.add('breath-hold');
                if (legacyBreathPhaseIdx === 2) breathCircle.classList.add('breath-out');
            }

             // --- New Breathing Animation logic ---
            async function initAudio() {
                if (isAudioReady) return;
                await Tone.start();
                guideSynth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.5, decay: 0.1, sustain: 0.8, release: 1 },
                }).toDestination();
                
                noise = new Tone.Noise("pink");
                musicFilter = new Tone.AutoFilter({
                    frequency: "8m",
                    baseFrequency: 200,
                    octaves: 3
                }).toDestination();
                noise.connect(musicFilter);

                isAudioReady = true;
            }

            function initBreathingAnimation() {
                stopBreathingAnimation();
            }

            async function startBreathingAnimation() {
                if (breathTimer) return;
                try {
                    await initAudio();
                } catch (error) {
                    console.error("Failed to initialize audio for breathing exercise:", error);
                    breathingAnimationInstruction.textContent = "Audio failed to start.";
                    breathingAnimationInstruction.classList.add('text-red-500');
                    return;
                }
                
                musicFilter.start();
                noise.start();

                breathTimer = setInterval(() => {
                    breathRemaining--;
                    if (breathRemaining <= 0) {
                        breathPhaseIdx = (breathPhaseIdx + 1) % 3;
                        breathRemaining = breathDurations[breathPhaseIdx];
                        updateBreathingAnimationUI(true); // Phase changed
                    } else {
                        updateBreathingAnimationUI(false); // Only countdown
                    }
                }, 1000);
                
                updateBreathingAnimationUI(true);
                breathingPulseCircle.classList.add('breathing-active');
            }

            function stopBreathingAnimation() {
                clearInterval(breathTimer);
                breathTimer = null;
                if(isAudioReady) {
                    musicFilter.stop();
                    noise.stop();
                    guideSynth.triggerRelease();
                }
                breathingPulseCircle.classList.remove('breathing-active');
                
                breathPhaseIdx = 0; 
                breathRemaining = 4;

                breathingAnimationPhase.textContent = 'Ready';
                breathingAnimationInstruction.textContent = 'Press start to begin a guided session.';
                breathingAnimationCircle.classList.remove('breath-in', 'breath-hold', 'breath-out');
            }

            function updateBreathingAnimationUI(phaseChanged) {
                const currentDuration = breathDurations[breathPhaseIdx];
                const phaseLabel = breathLabels[breathPhaseIdx];

                breathingAnimationPhase.textContent = `${breathRemaining}s`;
                breathingAnimationInstruction.textContent = `${phaseLabel} for ${currentDuration} seconds.`;

                breathingAnimationCircle.classList.remove('breath-in', 'breath-hold', 'breath-out');
                if (breathPhaseIdx === 0) breathingAnimationCircle.classList.add('breath-in');
                if (breathPhaseIdx === 1) breathingAnimationCircle.classList.add('breath-hold');
                if (breathPhaseIdx === 2) breathingAnimationCircle.classList.add('breath-out');
                
                if (isAudioReady && phaseChanged) {
                    guideSynth.triggerAttackRelease(breathNotes[breathPhaseIdx], '1s');
                }
            }
        });
    </script>
</body>
</html>

